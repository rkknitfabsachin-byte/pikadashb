<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PI Dashboard</title>

<style>
body{
  margin:0;
  font-family:Inter,system-ui;
  background:#f1f5f9;
}
.wrap{max-width:1300px;margin:auto;padding:14px;}
h1{margin-bottom:12px}

.piCard{
  background:white;
  border-radius:16px;
  box-shadow:0 8px 22px rgba(0,0,0,.08);
  margin-bottom:14px;
  overflow:hidden;
}

.piHead{
  display:grid;
  grid-template-columns:1fr 1.5fr 1fr 1fr 1fr 1fr auto;
  gap:10px;
  padding:14px;
  align-items:center;
  font-size:13px;
}
.piHead strong{font-size:14px}

.piItems{
  display:none;
  border-top:1px solid #e5e7eb;
}

.piItems table{
  width:100%;
  border-collapse:collapse;
}
.piItems th,.piItems td{
  padding:10px;
  font-size:13px;
  border-bottom:1px solid #e5e7eb;
  text-align:center;
}
.piItems th{background:#f1f5f9}

.toggle{
  cursor:pointer;
  font-size:18px;
}

a{color:#2563eb;text-decoration:none}

@media(max-width:900px){
  .piHead{
    grid-template-columns:1fr 1fr;
    row-gap:6px;
  }
}
</style>
</head>

<body>
<div class="wrap">
<h1>Proforma Invoice Dashboard</h1>

<div id="list"></div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwX0Nw7eLYhD1uQaNrSXr80CMnugOHU3PGccZmbtiNqC5C72hboQCbYPOg7ee1on3RX/exec";

fetch(API_URL).then(r=>r.json()).then(rows=>{
  const grouped = groupByPI(rows);
  render(grouped);
});

function fmt(d){
  if(!d) return "";
  return new Date(d).toLocaleDateString("en-GB");
}

function groupByPI(rows){
  const map = {};
  rows.forEach(r=>{
    const pi = r["PI No"];
    if(!map[pi]){
      map[pi] = {
        piNo: pi,
        date: r.Date,
        party: r["Party Name"],
        subtotal: r.Subtotal,
        gst: r.GST_5pct,
        grand: r["Grand Total"],
        pdf: r["PDF Link"],
        items: [],
        totalQty: 0
      };
    }
    map[pi].items.push({
      item:r.Item,
      color:r.Color,
      gsm:r.GSM,
      dia:r.DIA,
      qty:r.Qty,
      rate:r.Rate,
      amount:r.Amount
    });
    map[pi].totalQty += Number(r.Qty||0);
  });
  return Object.values(map);
}

function render(data){
  const box=document.getElementById("list");
  box.innerHTML="";

  data.forEach((pi,i)=>{
    const id="pi_"+i;
    box.insertAdjacentHTML("beforeend",`
      <div class="piCard">
        <div class="piHead">
          <strong>${pi.piNo}</strong>
          <div>${pi.party}</div>
          <div>${fmt(pi.date)}</div>
          <div>Items: ${pi.items.length}</div>
          <div>Qty: ${pi.totalQty}</div>
          <div>₹ ${pi.grand}</div>
          <div class="toggle" onclick="toggle('${id}')">▾</div>
        </div>

        <div class="piItems" id="${id}">
          <table>
            <thead>
              <tr>
                <th>Item</th><th>Color</th><th>GSM</th><th>DIA</th>
                <th>Qty</th><th>Rate</th><th>Amount</th>
              </tr>
            </thead>
            <tbody>
              ${pi.items.map(it=>`
                <tr>
                  <td>${it.item}</td>
                  <td>${it.color}</td>
                  <td>${it.gsm}</td>
                  <td>${it.dia}</td>
                  <td>${it.qty}</td>
                  <td>${it.rate}</td>
                  <td>${it.amount}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      </div>
    `);
  });
}

function toggle(id){
  const el=document.getElementById(id);
  el.style.display = el.style.display==="block" ? "none" : "block";
}
</script>
</body>
</html>
